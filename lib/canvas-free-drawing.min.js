(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports):typeof define==="function"&&define.amd?define(["exports"],e):(t=t||self,e(t.CanvasFreeDrawing={}))})(this,function(t){"use strict";function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t["default"]:t}function s(t,e){return e={exports:{}},t(e,e.exports),e.exports}var o=s(function(t,e){Object.defineProperty(e,"__esModule",{value:true});var s;(function(t){t["redraw"]="redraw";t["fill"]="fill";t["mouseup"]="mouseup";t["mousedown"]="mousedown";t["mouseenter"]="mouseenter";t["mouseleave"]="mouseleave"})(s=e.AllowedEvents||(e.AllowedEvents={}));var o=function(){function t(t){var e=t.elementId,s=t.width,o=t.height,i=t.backgroundColor,n=i===void 0?[255,255,255]:i,r=t.lineWidth,a=r===void 0?5:r,h=t.strokeColor,u=h===void 0?[0,0,0]:h,l=t.disabled,d=t.showWarnings,c=d===void 0?false:d,v=t.maxSnapshots,p=v===void 0?10:v;this.requiredParam(t,"elementId");this.requiredParam(t,"width");this.requiredParam(t,"height");this.elementId=e;this.canvasNode=document.getElementById(this.elementId);if(this.canvasNode instanceof HTMLCanvasElement){this.canvas=this.canvasNode}else if(this.canvasNode instanceof HTMLElement){var f=document.createElement("canvas");this.canvasNode.appendChild(f);this.canvas=f}else{throw new Error("No element found with following id: "+this.elementId)}this.context=this.canvas.getContext("2d");this.width=s;this.height=o;this.maxSnapshots=p;this.snapshots=[];this.undos=[];this.positions=[];this.leftCanvasDrawing=false;this.isDrawing=false;this.isDrawingModeEnabled=true;this.imageRestored=false;this.lineWidth=a;this.strokeColor=this.toValidColor(u);this.bucketToolColor=this.toValidColor(u);this.bucketToolTolerance=0;this.isBucketToolEnabled=false;this.listenersList=["mouseDown","mouseMove","mouseLeave","mouseUp","touchStart","touchMove","touchEnd"];this.allowedEvents=this.getAllowedEvents();this.redrawCounter=0;this.dispatchEventsOnceEvery=0;this.events={redrawEvent:new Event("cfd_redraw"),fillEvent:new Event("cfd_fill"),mouseUpEvent:new Event("cfd_mouseup"),mouseDownEvent:new Event("cfd_mousedown"),mouseEnterEvent:new Event("cfd_mouseenter"),mouseLeaveEvent:new Event("cfd_mouseleave"),touchStartEvent:new Event("cfd_touchstart"),touchEndEvent:new Event("cfd_touchend")};this.bindings={mouseDown:this.mouseDown.bind(this),mouseMove:this.mouseMove.bind(this),mouseLeave:this.mouseLeave.bind(this),mouseUp:this.mouseUp.bind(this),mouseUpDocument:this.mouseUpDocument.bind(this),touchStart:this.touchStart.bind(this),touchMove:this.touchMove.bind(this),touchEnd:this.touchEnd.bind(this)};this.touchIdentifier=undefined;this.previousX=undefined;this.previousY=undefined;this.showWarnings=c;this.isNodeColorEqualCache={};this.setDimensions();this.setBackground(n);this.storeSnapshot();if(!l)this.enableDrawingMode()}t.prototype.requiredParam=function(t,e){if(!t||!t[e]){throw new Error(e+" is required")}};t.prototype.logWarning=function(){var t=[];for(var e=0;e<arguments.length;e++){t[e]=arguments[e]}if(this.showWarnings)console.warn.apply(console,t)};t.prototype.addListeners=function(){var t=this;this.listenersList.forEach(function(e){t.canvas.addEventListener(e.toLowerCase(),t.bindings[e])});document.addEventListener("mouseup",this.bindings.mouseUpDocument)};t.prototype.removeListeners=function(){var t=this;this.listenersList.forEach(function(e){t.canvas.removeEventListener(e.toLowerCase(),t.bindings[e])});document.removeEventListener("mouseup",this.bindings.mouseUpDocument)};t.prototype.getAllowedEvents=function(){var t=[];for(var e in s){t.push(e)}return t};t.prototype.enableDrawingMode=function(){this.isDrawingModeEnabled=true;this.addListeners();this.toggleCursor();return this.isDrawingModeEnabled};t.prototype.disableDrawingMode=function(){this.isDrawingModeEnabled=false;this.removeListeners();this.toggleCursor();return this.isDrawingModeEnabled};t.prototype.mouseDown=function(t){if(t.button!==0)return;var e=t.pageX-this.canvas.offsetLeft;var s=t.pageY-this.canvas.offsetTop;this.drawPoint(e,s)};t.prototype.mouseMove=function(t){var e=t.pageX-this.canvas.offsetLeft;var s=t.pageY-this.canvas.offsetTop;this.drawLine(e,s,t)};t.prototype.touchStart=function(t){if(t.changedTouches.length>0){var e=t.changedTouches[0],s=e.pageX,o=e.pageY,i=e.identifier;var n=s-this.canvas.offsetLeft;var r=o-this.canvas.offsetTop;this.touchIdentifier=i;this.drawPoint(n,r)}};t.prototype.touchMove=function(t){if(t.changedTouches.length>0){var e=t.changedTouches[0],s=e.pageX,o=e.pageY,i=e.identifier;var n=s-this.canvas.offsetLeft;var r=o-this.canvas.offsetTop;if(i!=this.touchIdentifier)return;this.previousX=n;this.previousY=r;this.drawLine(n,r,t)}};t.prototype.touchEnd=function(){this.handleEndDrawing();this.canvas.dispatchEvent(this.events.touchEndEvent)};t.prototype.mouseUp=function(){this.handleEndDrawing();this.canvas.dispatchEvent(this.events.mouseUpEvent)};t.prototype.mouseUpDocument=function(){this.leftCanvasDrawing=false};t.prototype.mouseLeave=function(){if(this.isDrawing)this.leftCanvasDrawing=true;this.isDrawing=false;this.canvas.dispatchEvent(this.events.mouseLeaveEvent)};t.prototype.mouseEnter=function(){this.canvas.dispatchEvent(this.events.mouseEnterEvent)};t.prototype.handleEndDrawing=function(){this.isDrawing=false;this.storeSnapshot()};t.prototype.drawPoint=function(t,e){if(this.isBucketToolEnabled){this.fill(t,e,this.bucketToolColor,{tolerance:this.bucketToolTolerance})}else{this.isDrawing=true;this.storeDrawing(t,e,false);this.canvas.dispatchEvent(this.events.mouseDownEvent);this.handleDrawing()}};t.prototype.drawLine=function(t,e,s){if(this.leftCanvasDrawing){this.leftCanvasDrawing=false;if(s instanceof MouseEvent){this.mouseDown(s)}else if(s instanceof TouchEvent){this.touchEnd()}}if(this.isDrawing){this.storeDrawing(t,e,true);this.handleDrawing(this.dispatchEventsOnceEvery)}};t.prototype.handleDrawing=function(t){var e=this;this.context.lineJoin="round";var s=[this.positions.slice().pop()];s.forEach(function(t){if(t&&t[0]&&t[0].strokeColor){e.context.strokeStyle=e.rgbaFromArray(t[0].strokeColor);e.context.lineWidth=t[0].lineWidth;e.draw(t)}});if(!t){this.canvas.dispatchEvent(this.events.redrawEvent)}else if(this.redrawCounter%t===0){this.canvas.dispatchEvent(this.events.redrawEvent)}this.undos=[];this.redrawCounter+=1};t.prototype.draw=function(t){var e=this;t.forEach(function(s,o){var i=s.x,n=s.y,r=s.moving;e.context.beginPath();if(r&&o){e.context.moveTo(t[o-1]["x"],t[o-1]["y"])}else{e.context.moveTo(i-1,n)}e.context.lineTo(i,n);e.context.closePath();e.context.stroke()})};t.prototype.fill=function(t,e,s,o){var i=o.tolerance;s=this.toValidColor(s);if(this.positions.length===0&&!this.imageRestored){this.setBackground(s,false);this.canvas.dispatchEvent(this.events.redrawEvent);this.canvas.dispatchEvent(this.events.fillEvent);return}var n=this.width*this.height;var r=this.context.getImageData(0,0,this.width,this.height);var a=r.data;var h=this.getNodeColor(t,e,a);if(this.isNodeColorEqual(h,s,i))return;var u=[];u.push([t,e]);while(u.length){if(u.length>n)break;var l=u.pop();var d=l;var c=l;while(this.isNodeColorEqual(this.getNodeColor(d[0]-1,d[1],a),h,i)){d=[d[0]-1,d[1]]}while(this.isNodeColorEqual(this.getNodeColor(c[0]+1,c[1],a),h,i)){c=[c[0]+1,c[1]]}var v=d[0];var p=c[0];for(var f=v;f<=p;f++){this.setNodeColor(f,d[1],s,a);if(this.isNodeColorEqual(this.getNodeColor(f,d[1]+1,a),h,i)){u.push([f,d[1]+1])}if(this.isNodeColorEqual(this.getNodeColor(f,d[1]-1,a),h,i)){u.push([f,d[1]-1])}}}this.context.putImageData(r,0,0);this.canvas.dispatchEvent(this.events.redrawEvent);this.canvas.dispatchEvent(this.events.fillEvent)};t.prototype.toValidColor=function(t){if(Array.isArray(t)&&t.length===4)t.pop();if(Array.isArray(t)&&t.length===3){var e=t.slice();e.push(255);return e}else{this.logWarning("Color is not valid!\n"+"It must be an array with RGB values:  [0-255, 0-255, 0-255]");return[0,0,0,255]}};t.prototype.isNodeColorEqual=function(t,e,s){var o=""+t[0]+t[1]+t[2]+t[3];var i=""+e[0]+e[1]+e[2]+e[3];var n=o+i+s;s=s||0;if(this.isNodeColorEqualCache.hasOwnProperty(o+i+s)){return this.isNodeColorEqualCache[n]}var r=Math.abs(e[0]-t[0]);var a=Math.abs(e[1]-t[1]);var h=Math.abs(e[2]-t[2]);var u=r/255;var l=a/255;var d=h/255;var c=(u+l+d)/3*100;var v=s>=c;this.isNodeColorEqualCache[n]=v;return v};t.prototype.getNodeColor=function(t,e,s){var o=(t+e*this.width)*4;return[s[o],s[o+1],s[o+2],s[o+3]]};t.prototype.setNodeColor=function(t,e,s,o){var i=(t+e*this.width)*4;o[i]=s[0];o[i+1]=s[1];o[i+2]=s[2];o[i+3]=s[3]};t.prototype.rgbaFromArray=function(t){return"rgba("+t[0]+","+t[1]+","+t[2]+","+t[3]+")"};t.prototype.setDimensions=function(){this.canvas.height=this.height;this.canvas.width=this.width};t.prototype.toggleCursor=function(){this.canvas.style.cursor=this.isDrawingModeEnabled?"crosshair":"auto"};t.prototype.storeDrawing=function(t,e,s){if(s){var o=this.positions.length-1;this.positions[o].push({x:t,y:e,moving:s,lineWidth:this.lineWidth,strokeColor:this.strokeColor,isBucket:false})}else{this.positions.push([{x:t,y:e,isBucket:false,moving:s,lineWidth:this.lineWidth,strokeColor:this.strokeColor}])}};t.prototype.storeSnapshot=function(){var t=this.getCanvasSnapshot();this.snapshots.push(t);if(this.snapshots.length>this.maxSnapshots){this.snapshots=this.snapshots.splice(-Math.abs(this.maxSnapshots))}};t.prototype.getCanvasSnapshot=function(){return this.context.getImageData(0,0,this.width,this.height)};t.prototype.restoreCanvasSnapshot=function(t){this.context.putImageData(t,0,0)};t.prototype.on=function(t,e){var s=t.event,o=t.counter;this.requiredParam(t,"event");if(this.allowedEvents.includes(s)){if(s==="redraw"&&o&&Number.isInteger(o)){this.dispatchEventsOnceEvery=o}this.canvas.addEventListener("cfd_"+s,function(){return e()})}else{this.logWarning("This event is not allowed: "+s)}};t.prototype.setLineWidth=function(t){this.lineWidth=t};t.prototype.setBackground=function(t,e){if(e===void 0){e=true}var s=this.toValidColor(t);if(s){if(e)this.backgroundColor=s;this.context.fillStyle=this.rgbaFromArray(s);this.context.fillRect(0,0,this.width,this.height)}};t.prototype.setDrawingColor=function(t){this.configBucketTool({color:t});this.setStrokeColor(t)};t.prototype.setStrokeColor=function(t){this.strokeColor=this.toValidColor(t)};t.prototype.configBucketTool=function(t){var e=t.color,s=e===void 0?null:e,o=t.tolerance,i=o===void 0?null:o;if(s)this.bucketToolColor=this.toValidColor(s);if(i&&i>0){this.bucketToolTolerance=i>100?100:i}};t.prototype.toggleBucketTool=function(){return this.isBucketToolEnabled=!this.isBucketToolEnabled};t.prototype.toggleDrawingMode=function(){return this.isDrawingModeEnabled?this.disableDrawingMode():this.enableDrawingMode()};t.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height);this.positions=[];this.imageRestored=false;if(this.backgroundColor)this.setBackground(this.backgroundColor);this.handleEndDrawing()};t.prototype.save=function(){return this.canvas.toDataURL()};t.prototype.restore=function(t,e){var s=this;var o=new Image;o.src=t;o.onload=function(){s.imageRestored=true;s.context.drawImage(o,0,0);if(typeof e==="function")e()}};t.prototype.undo=function(){var t=this.snapshots[this.snapshots.length-1];var e=this.snapshots[this.snapshots.length-2];if(e){this.restoreCanvasSnapshot(e);this.snapshots.pop();this.undos.push(t);this.undos=this.undos.splice(-Math.abs(this.maxSnapshots));this.imageRestored=true}else{this.logWarning("There are no more undos left.")}};t.prototype.redo=function(){if(this.undos.length>0){var t=this.undos.pop();if(t){this.restoreCanvasSnapshot(t);this.snapshots.push(t);this.snapshots=this.snapshots.splice(-Math.abs(this.maxSnapshots))}}else{this.logWarning("There are no more redo left.")}};return t}();e.default=o});var i=e(o);var n=o.AllowedEvents;t.AllowedEvents=n;t.default=i;Object.defineProperty(t,"__esModule",{value:true})});